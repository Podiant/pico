!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";function t(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function n(t,n){for(var e=0;e<n.length;e++){var a=n[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function e(t,e,a){return e&&n(t.prototype,e),a&&n(t,a),t}function a(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&r(t,n)}function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,n){return(r=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function o(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function c(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?o(t):n}var s=function(){function n(){t(this,n),this.__callbacks={}}return e(n,[{key:"on",value:function(t,n){return void 0===this.__callbacks[t]&&(this.__callbacks[t]=[]),this.__callbacks[t].push(n),this}},{key:"off",value:function(t,n){var e=this.__callbacks[t];if(void 0===e)return this;var a=[];if(void 0!==n)for(var i=0;i<e.length;i++)e[i]!==n&&a.push(e[i]);return this.__callbacks[t]=a,this}},{key:"emit",value:function(t){var n=this.__callbacks[t],e=Array.from(arguments).slice(1);if(void 0!==n)for(var a=0;a<n.length;a++)n[a].apply(this,e);return this}}]),n}(),u=function(n){function r(n){var e,a=n.plugins,s=n.views;return t(this,r),(e=c(this,i(r).call(this))).__plugins=[],e.__views=[],Array.isArray(a)&&a.forEach((function(t){var n=new t(o(e));e.__plugins.push(n)})),Array.isArray(s)&&s.forEach((function(t){var n=new t(o(e));e.__views.push(n)})),e.$=window.$,e.$(document).ready((function(){e.ready()})),e}return a(r,n),e(r,[{key:"ready",value:function(){var t=this.$("body");this.__views.forEach((function(n){var e=n.classNames(),a=!1;e.forEach((function(n){a||t.hasClass(n)||(a=!0)})),a||n.ready()})),this.emit("ready")}}]),r}(s),d=function(n){function r(n){var e;return t(this,r),(e=c(this,i(r).call(this))).app=n,n.on("ready",e.ready),e}return a(r,n),e(r,[{key:"ready",value:function(){}}]),r}(s),l=function(n){function r(){return t(this,r),c(this,i(r).apply(this,arguments))}return a(r,n),e(r,[{key:"check",value:function(t){var n=this;return new Promise((function(e,a){n.emit("validating"),n.validate(t).then((function(t){n.emit("valid"),e(t)})).catch((function(t){n.emit("invalid",t),a(t)}))}))}},{key:"validate",value:function(){throw new Error("Method not implemented")}}]),r}(s),f=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,h=function(n){function r(){return t(this,r),c(this,i(r).apply(this,arguments))}return a(r,n),e(r,[{key:"validate",value:function(t){return new Promise((function(n,e){var a=String(t).toLowerCase();f.test(a)?n(a):e(new Error("This doesn't look like an email address."))}))}}]),r}(l),v=function(n){function r(n){var e;return t(this,r),(e=c(this,i(r).call(this))).basis=n,e}return a(r,n),e(r,[{key:"validate",value:function(t){var n=this;return new Promise((function(e,a){var i=new WebSocket("ws://".concat(window.location.host,"/ws/unique/").concat(n.basis,"/")),r=!1,o=!1;i.onclose=function(){o||r||a(new Error("An error occurred while communicating with the server."))},i.onmessage=function(n){var c=JSON.parse(n.data);c.valid?o||r||(r=!0,i.close(),e(t)):o||r||(o=!0,i.close(),a(new Error(c.error)))},i.onopen=function(){i.send(t)}}))}}]),r}(l),p=function(n){function r(n){var e;return t(this,r),(e=c(this,i(r).call(this))).checkAgainst=n,e}return a(r,n),e(r,[{key:"validate",value:function(t){var n=this;return new Promise((function(e,a){t!==n.checkAgainst?a(new Error("This value doesn't match the previous one.")):e(t)}))}}]),r}(l),w=function(n){function r(n){var e;return t(this,r),(e=c(this,i(r).call(this))).basis=n,e}return a(r,n),e(r,[{key:"validate",value:function(t){var n=this;return new Promise((function(e,a){var i=new WebSocket("ws://".concat(window.location.host,"/ws/validate/").concat(n.basis,"/")),r=!1,o=!1;i.onclose=function(){o||r||a(new Error("An error occurred while communicating with the server."))},i.onmessage=function(n){var c=JSON.parse(n.data);c.valid?o||r||(r=!0,i.close(),e(t)):o||r||(o=!0,i.close(),a(new Error(c.error)))},i.onopen=function(){i.send(t)}}))}}]),r}(l),m=function(n){function e(n,a){var r;t(this,e),r=c(this,i(e).call(this));r.show=function(t){return new Promise((function(n){a.hasClass("active")&&(r.emit("shown"),n()),r.emit("showing"),t?a.addClass("showing-"+t):a.addClass("showing"),setTimeout((function(){t?a.removeClass("showing-"+t):a.removeClass("showing"),r.emit("shown"),n()}),333)}))},r.hide=function(t){return new Promise((function(n){r.emit("hiding"),t?a.addClass("hiding-"+t):a.addClass("hiding"),setTimeout((function(){t?a.removeClass("hiding-"+t):a.removeClass("hiding"),r.emit("hidden"),n()}),333)}))},r.on("showing",(function(){a.addClass("active"),a.trigger("wizard.showing")})),r.on("hidden",(function(){a.removeClass("active"),a.trigger("wizard.hidden")})),r.on("shown",(function(){a.find(":input").first().focus(),a.trigger("wizard.shown")})),r.on("validation",(function(t){if(void 0===t)return a.find(":input.is-invalid").removeClass("is-invalid"),void a.find(".invalid-feedback").remove();var n=window.$(t.field),e=n.closest(".form-group"),i=e.find(".invalid-feedback");n.addClass("is-invalid"),i.length||(i=window.$("<div>").addClass("invalid-feedback")).appendTo(e),i.text(t.message),n.focus()})),r.prev=function(){r.hide("rw").then((function(){r.emit("moving.prev"),r.emit("prev")}))},r.next=function(){var t,n,e;t=a.find('button, input[type="button"]').attr("disabled","disabled"),n=a.find(":input").not(t).not("[disabled]"),e=function(){t.removeAttr("disabled"),n.removeAttr("disabled")},n.attr("disabled","disabled"),r.on("moving.next",e),r.on("validation",(function(t){t&&e()})),r.emit("validation"),r.validate().then((function(){r.emit("moving.next"),r.hide("ff").then((function(){r.emit("next")}))})).catch((function(t){r.emit("validation",t)}))},r.validate=function(){return new Promise((function(t,n){var e=!1,i=[],r=a.closest("form");a.find(":input").each((function(){if(e)return!1;var t=window.$(this),a=t.val(),o=t.attr("required"),c=t.attr("type")||"text",s=t.attr("data-unique"),u=t.attr("data-validator"),d=t.attr("data-pair");if(o&&!a.trim())return e=!0,n({field:t,message:"This field is required."}),!1;switch(c){case"email":i.push([new h,t])}s&&i.push([new v(s),t]),u&&i.push([new w(u),t]),d&&i.push([new p(r.find(':input[name="'.concat(d,'"]')).val()),t])}));i.length?function a(){var r=i.shift(),o=r[0],c=r[1],s=c.val().trim();o.check(s).then((function(){i.length?a():e||t()})).catch((function(t){e||(e=!0,n({field:c,message:t.message}))}))}():e||t()}))};var s=o(r);return a.on("click",'[data-action="prev"]',(function(){s.prev()})),a.on("click","[data-skip]",(function(){var t=parseInt(window.$(this).data("skip"));s.hide("ff"),s.emit("skip",t)})),a.on("click",'[data-action="next"]',(function(){s.next()})),a.on("keydown",":input",(function(t){13===t.keyCode&&(t.preventDefault(),s.next())})),r}return a(e,n),e}(s),b=function(n){function e(n){var a;t(this,e);var r=o(a=c(this,i(e).call(this))),s=[];return n.find(".step").each((function(){var t=window.$(this),n=new m(r,t);t.data("wizard-step",n),s.push(n)})),s.forEach((function(t,n){n>0&&t.on("moving.prev",(function(){s[n-1].show("rw")})),n<s.length-1?t.on("moving.next",(function(){s[n+1].show("ff")})):t.on("next",(function(){a.submit()})),t.on("skip",(function(t){s[t].show("ff")}))})),a.show=function(t){void 0===t&&(t=0),n.find(".step").each((function(n){if(window.$(this).find(".form-group.is-invalid").length)return t=n,!1})),s[t].show()},a.submit=function(){n.closest("form").submit()},a}return a(e,n),e}(s),g=function(n){function r(){return t(this,r),c(this,i(r).apply(this,arguments))}return a(r,n),e(r,[{key:"ready",value:function(){var t=this.$;t(".wizard").each((function(){new b(t(this)).show()}))}}]),r}(d),y=function(n){function e(n){var a;t(this,e),a=c(this,i(e).call(this));var r=n.find('input[type="file"]'),s=r.attr("accept"),u=o(a),d=function(t){if(s){var n=new RegExp("^"+s.replace("/","\\/").replace("*",".*"));if(!t.type.match(n))return!1}return!0};return n.on("dragenter",(function(t){t.preventDefault(),n.addClass("active"),a.emit("drag.enter")})).on("dragleave",(function(t){t.preventDefault(),n.removeClass("active"),a.emit("drag.exit")})).on("dragover",(function(t){t.preventDefault(),n.addClass("active"),a.emit("drag.over")})).on("drop",(function(t){if(t.preventDefault(),1===t.originalEvent.dataTransfer.files.length){var n=0;for(n=0;n<t.originalEvent.dataTransfer.files.length;n++)if(!d(t.originalEvent.dataTransfer.files[n]))return void a.emit("error",new Error("The dragged file was not of the correct type."));t.originalEvent.dataTransfer.files&&(r.get(0).files=t.originalEvent.dataTransfer.files,r.trigger("change"))}})).on("click",(function(t){t.target!==r.get(0)&&(t.preventDefault(),r.get(0).click())})),r.on("change",(function(){var t=0;for(t=0;t<this.files.length;t++)u.emit("file",this.files[t])})),a}return a(e,n),e}(s),k=function(n){function e(n){var a;return t(this,e),(a=c(this,i(e).call(this,n))).on("error",(function(){alert("Only images are supported here.")})),a.on("file",(function(t){var e=new FileReader;e.onload=function(t){n.css("background-image","url(".concat(t.target.result,")"))},e.readAsDataURL(t)})),a}return a(e,n),e}(y),C=function(n){function r(){return t(this,r),c(this,i(r).apply(this,arguments))}return a(r,n),e(r,[{key:"ready",value:function(){var t=this.$;t(".dropzone").each((function(){var n=t(this);n.hasClass("dropzone-image")?new k(n):new y(n)}))}}]),r}(d),E=function(t,n){void 0===n&&(n=333);var e=null,a=[],i=function(){t.apply(t,a),e=null};return function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];a=r,null===e&&(e=setTimeout(i,n))}},_=function(n){function e(n){var a;return t(this,e),(a=c(this,i(e).call(this))).data=n,a.attach=function(t){var e=window.$("<a>").addClass("typeahead-item").addClass("list-group-item").attr("href","javascript:;");if(n.thumbnail){var i=window.$("<div>").addClass("d-flex w-100"),r=window.$("<img>").attr("src",n.thumbnail).attr("height","30").addClass("mr-3"),o=window.$("<span>").text(n.label);r.appendTo(i),o.appendTo(i),i.appendTo(e)}else e.text(n.label);e.on("click",(function(){a.select()})),e.appendTo(t),a.focus=function(){e.addClass("active").addClass("list-item-active"),a.emit("focused")},a.blur=function(){e.removeClass("active").removeClass("list-item-active"),a.emit("blurred")},a.select=function(){e.addClass("active").addClass("list-item-active"),a.emit("selected")}},a.focus=function(){throw new Error("List item not attached to container DOM element.")},a.blur=function(){throw new Error("List item not attached to container DOM element.")},a}return a(e,n),e}(s),$=function(n){function e(n){var a;return t(this,e),(a=c(this,i(e).call(this))).attach=function(t){var e=window.$("<div>").addClass("typeahead-container").addClass("list-group"),i=t.offset(),r=null,o=[];n.forEach((function(t,n){var i=new _(t);i.index=n,i.on("focused",(function(){r!==i&&(null!==r&&r.blur(),r=i)})),i.on("selected",(function(){a.emit("selected",i)})),o.push(i),i.attach(e)})),e.css({position:"absolute",top:i.top+t.outerHeight(!0),left:i.left,width:t.outerWidth(!0)}),window.$("body").append(e),a.detatch=function(){e.remove()},a.moveUp=function(){var t=null;null!==r&&(t=r.index),t=null===t?n.length-1:Math.max(0,t-1),a.focus(t)},a.moveDown=function(){var t=null;null!==r&&(t=r.index),t=null===t?0:Math.min(n.length-1,t+1),a.focus(t)},a.focus=function(t){if(void 0===t)throw new Error("Expected index of item to select.");void 0!==o[t]?o[t].focus():(null!==r&&r.blur(),r=null)},a.select=function(){null!==r&&r.select()}},a.detatch=function(){throw new Error("List has not been attached to a DOM element.")},a}return a(e,n),e}(s),x=function(n){function e(n,a,r){var o;t(this,e),o=c(this,i(e).call(this));var s=n.attr("name"),u=window.$("<input>").attr("name",s).attr("type","hidden");n.removeAttr("name"),n.after(u);var d=new E((function(t){var e=a.replace("%s",encodeURIComponent(t));window.$.getJSON(e,(function(t){var e=r(t),a=new $(e);n.data("typeahed-list")&&n.data("typeahed-list").detatch(),o.on("move.up",(function(){a.moveUp()})),o.on("move.down",(function(){a.moveDown()})),o.on("select",(function(){a.select()})),a.on("selected",(function(t){u.val(t.data.id),n.val(t.data.label),a.detatch(),n.focus()})),a.attach(n),n.data("typeahed-list",a)}))}),900);return n.on("input",(function(){return d(n.val())})),n.on("keydown",(function(t){switch(t.keyCode){case 40:t.preventDefault(),o.emit("move.down");break;case 38:t.preventDefault(),o.emit("move.up");break;case 13:u.val()||(t.preventDefault(),t.stopPropagation(),o.emit("select"))}})),o}return a(e,n),e}(s),A=function(t){var n=t.indexOf(".$."),e=t.substr(0,n),a=t.substr(n+3);return function(t,n){var i=n[e][t];if(void 0===i)throw new Error("Index out of range.");return i[a]}},j=function(t){var n=t.indexOf(".$."),e=t.substr(0,n);return function(t){var n=t[e];if(Array.isArray(n))return n.length;throw new Error("Value is not an array.")}},z=function n(e){t(this,n),this.transform=function(t){var n=e.id,a=e.label,i=e.thumbnail,r=n?new A(n):null,o=a?new A(a):null,c=i?new A(i):null,s=new j(n),u=0;if(!r)throw new Error("No template provided for returning an object ID.");if(!o)throw new Error("No template provided for returning an object label.");try{u=s(t)}catch(t){throw new Error("Invalid data returned.")}var d,l,f=0,h=[];for(f=0;f<u;f++)h.push((d=f,l=void 0,(l={}).id=r(d,t),l.label=o(d,t),c&&(l.thumbnail=c(d,t)),l));return h}},O=function(n){function r(){return t(this,r),c(this,i(r).apply(this,arguments))}return a(r,n),e(r,[{key:"ready",value:function(){var t=this.$;t("input[data-typeahead-url]").each((function(){var n=t(this),e=n.data("typeahead-url"),a=new z(n.data("typeahead-transform")),i=new x(n,e,a.transform);n.removeAttr("data-typeahead-url"),n.removeAttr("data-typeahead-transform"),n.data("typeahead",i)}))}}]),r}(d),T=function(n){function r(n){var e;return t(this,r),(e=c(this,i(r).call(this))).app=n,e}return a(r,n),e(r,[{key:"classNames",value:function(){return[]}}]),e(r,[{key:"ready",value:function(){}}]),r}(s),D=function(n){function r(){return t(this,r),c(this,i(r).apply(this,arguments))}return a(r,n),e(r,[{key:"classNames",value:function(){return["projects","create-project"]}},{key:"ready",value:function(){var t=this.app.$,n=t('input[name="name"]'),e=t("#id_apple_podcasts_id");e.closest(".step").on("wizard.shown",(function(){e.val()&&e.trigger("input")})),n.on("change",(function(){e.val(n.val())}))}}]),r}(T),q=function(n){function r(n){var e;t(this,r),(e=c(this,i(r).call(this))).accepted=!1,e.rejected=!1,e.cancelled=!1,console.log("Requesting to add a card in",n.name);var a=setTimeout((function(){e.cancel()}),1e4);return e.on("accepted",(function(){clearTimeout(a)})),e.on("rejected",(function(){clearTimeout(a)})),e}return a(r,n),e(r,[{key:"accept",value:function(t){if(this.accepted||this.rejected||this.cancelled)throw new Error("Request is in an invalid state.");this.accepted=!0,this.emit("accepted",t)}},{key:"reject",value:function(){if(this.accepted||this.rejected||this.cancelled)throw new Error("Request is in an invalid state.");this.rejected=!0,this.emit("rejected")}},{key:"cancel",value:function(){if(this.accepted||this.rejected||this.cancelled)throw new Error("Request is in an invalid state.");this.cancelled=!0,this.emit("cancelled")}}]),r}(s),P=function(n){function e(){var n;return t(this,e),(n=c(this,i(e).call(this))).attach=function(t){var e=window.$("<div>").addClass("kanban-card card mb-3"),a=window.$("<div>").addClass("card-body");return e.append(a),t.append(e),n.populate(a),n.detatch=function(){e.remove(),n.emit("detatched")},e},n.populate=function(){},n.cancel=function(){n.emit("cancelled")},n.submit=function(t){n.emit("submitted",t)},n.detatch=function(){throw new Error("Card has not been attached to a DOM element.")},n}return a(e,n),e}(s),R=function(n){function e(n){var a;return t(this,e),(a=c(this,i(e).call(this,n))).populate=function(t){var e=window.$("<input>").attr("type","text").addClass("form-control");n.placeholder&&e.attr("placeholder",n.placeholder),e.on("keyup",(function(t){switch(t.keyCode){case 27:a.cancel();break;case 13:t.preventDefault(),a.submit(e.val())}})),t.append(e),e.focus()},a}return a(e,n),e}(P),N=function(n){function e(n){var a;return t(this,e),(a=c(this,i(e).call(this,n))).populate=function(t){var e=window.$("<span>").text(n.name);t.append(e)},a}return a(e,n),e}(P),S=function(n){function e(n,a){var r;t(this,e),(r=c(this,i(e).call(this))).name=a.name,r.on("attached",(function(){n.trigger("kanban.attached")})),r.on("cards.create.request",(function(){n.trigger("kanban.cards.create.request")}));var s=window.$("<h6>").text(a.name),u=window.$("<div>").addClass("kanban-list-container"),d=window.$("<div>").addClass("kanban-list-footer");if(a.can_create_cards){var l=window.$("<button>").addClass("btn btn-outline-primary btn-block").text("Add card");l.on("click",(function(t){if(t.preventDefault(),!l.attr("disabled")&&a.can_create_cards){var n=new q(o(r));n.on("accepted",(function(t){var n=new R(t);n.on("submitted",(function(t){n.detatch(),r.addCard(new N({name:t}))})).on("cancelled",(function(){n.detatch()})).on("detatched",(function(){l.removeAttr("disabled")})),n.attach(u)})).on("rejected",(function(t){console.warn("Request rejected.",t),l.removeAttr("disabled")})).on("cancelled",(function(){console.warn("Request was not fulfilled in time."),l.removeAttr("disabled")})),l.attr("disabled","disabled"),r.emit("cards.create.request",n)}})),d.append(l)}return r.addCard=function(t){var e=t.attach(u);e.data("kanban-card",t),r.emit("card.created",t),n.trigger("kanban.card.created",e)},n.append(s),n.append(u),n.append(d),r}return a(e,n),e}(s),M=function(n){function e(n,a){var r;t(this,e),r=c(this,i(e).call(this));var o=window.$("<div>").addClass("kanban-column-row");r.on("freeze",(function(){console.debug("Board frozen."),n.find("a[href], button").each((function(){var t=window.$(this);t.data("frozen")||t.attr("disabled")||(t.attr("disabled","disabled"),t.data("frozen",!0))})),n.addClass("kanban-frozen")})).on("unfreeze",(function(){console.debug("Board unfrozen."),n.find("a[href], button").each((function(){var t=window.$(this);t.data("frozen")&&(t.removeAttr("disabled"),t.data("frozen",!1))})),n.removeClass("kanban-frozen")})),n.append(o),r.emit("freeze");var s=new WebSocket("ws://".concat(window.location.host,"/ws/kanban/").concat(a,"/"));return s.onclose=function(){console.warn("Kanban board socket closed unexpectedly."),r.emit("error"),r.emit("freeze")},s.onmessage=function(t){var n=JSON.parse(t.data);n.columns&&(o.html("").css({width:0}),n.columns.forEach((function(t){var n=window.$("<div>").addClass("kanban-column"),e=new S(n,t);e.on("cards.create.request",(function(t){r.emit("cards.create.request",t,e)})),n.data("kanban-column",e),o.append(n),e.emit("attached");var a=n.outerWidth(!0);o.width(o.width()+a+15)})),r.emit("unfreeze"))},s.onopen=function(){console.debug("Opened a socket to the Kanban board."),s.send("get")},r}return a(e,n),e}(s),I=function(n){function r(){return t(this,r),c(this,i(r).apply(this,arguments))}return a(r,n),e(r,[{key:"classNames",value:function(){return["projects","board-detail"]}},{key:"ready",value:function(){var t=this.app.$;t(".kanban-board[data-id]").each((function(){var n=t(this),e=new M(n,n.data("id"));e.on("cards.create.request",(function(t){t.accept({placeholder:"Episode title"})})),n.removeAttr("data-id"),n.data("kanban-board",e)}))}}]),r}(T);window.Pico=new u({plugins:[g,C,O],views:[D,I]})}));
//# sourceMappingURL=pico.js.map